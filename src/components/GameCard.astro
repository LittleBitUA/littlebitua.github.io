---
// ─── GameCard Component ────────────────────────────────────────
// Compact vertical card for grid layout.
// Cover on top, info below, progress bar with expandable stage details.

import ProgressBar from "./ProgressBar.astro";
import Tag from "./Tag.astro";
import type { Game } from "../data/games";
import { STATUS_LABELS, STATUS_COLORS, STAGE_COLORS } from "../data/games";
import "@fortawesome/fontawesome-free/css/all.css";

export interface Props {
  game: Game;
}

const { game } = Astro.props;
const statusLabel = game.status === "fundraising" ? STATUS_LABELS[game.status] : (game.stage ?? STATUS_LABELS[game.status]);
const statusColor = STATUS_COLORS[game.status];
const stageColor = game.stage ? STAGE_COLORS[game.stage] : "";
const hasDetails = game.stageDetails && game.stageDetails.length > 0;
---

<article
  class="game-card glass group hover:glow-accent transition-all duration-300 overflow-hidden flex flex-col"
  data-game-id={game.id}
  data-series={game.series}
  data-status={game.status}
  data-title={game.title}
  data-tags={game.tags.join(",")}
  data-progress={game.progress}
  data-platform={game.platform?.join(",") || ""}
  data-translation-size={game.translationSize || ""}
  data-game-year={game.gameYear || 0}
  data-last-update={game.lastUpdate || ""}
  data-animate
>
  <!-- Cover (Steam 600×900 = 2:3 portrait) -->
  <div class="relative aspect-[2/3] overflow-hidden">
    <img
      src={game.cover}
      alt={game.title}
      class="absolute inset-0 w-full h-full object-cover"
      loading="lazy"
    />

    <!-- Status / Stage badge -->
    <div class="absolute top-2.5 left-2.5">
      <span
        class:list={[
          "inline-flex items-center gap-1 px-2.5 py-0.5 text-[10px] font-bold rounded-md border backdrop-blur-md bg-black/60",
          game.stage && (game.status === "early-access" || game.status === "in-progress")
            ? `${stageColor} border-white/15`
            : statusColor,
        ]}
      >
        {game.status === "done" && (
          <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
          </svg>
        )}
        {game.status === "planned" && (
          <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        )}
        {(game.status === "early-access" || game.status === "in-progress") && (
          <span class="w-1.5 h-1.5 rounded-full bg-current animate-pulse" />
        )}
        {game.status === "fundraising" && (
          <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        )}
        {statusLabel}
      </span>
    </div>

    <!-- Progress % overlay -->
    <div class="absolute top-2.5 right-2.5">
      <span class="px-2 py-0.5 text-sm font-extrabold tabular-nums text-white bg-black/60 backdrop-blur-md rounded-md">
        {game.progress}<span class="text-[10px] font-medium opacity-60">%</span>
      </span>
    </div>

    <!-- Bottom gradient fade into content -->
    <div class="absolute bottom-0 left-0 right-0 h-12 bg-gradient-to-t from-surface-700/40 to-transparent" />
  </div>

  <!-- Content -->
  <div class="p-4 flex flex-col flex-1">
    <!-- Title -->
    <h3 class="text-base font-bold leading-snug mb-2 line-clamp-2">
      <a
        href={`/projects/${game.id}`}
        class="text-white hover:text-accent-light transition-colors duration-300"
      >
        {game.title}
      </a>
    </h3>

    <!-- Description -->
    <p class="card-desc text-xs text-surface-200/70 leading-relaxed mb-3 line-clamp-2 flex-1 transition-all duration-300">
      {game.description}
    </p>

    <!-- Progress section -->
    <div class="mb-3">
      {hasDetails ? (
        <div class="game-progress-toggle cursor-pointer" data-expanded="false">
          <!-- Main progress bar + expand hint -->
          <div class="flex items-center gap-2">
            <div class="flex-1">
              <ProgressBar percent={game.progress} size="sm" />
            </div>
            <button
              type="button"
              class="expand-btn flex-shrink-0 w-6 h-6 rounded-md bg-surface-600/50 border border-white/5
                     flex items-center justify-center text-surface-300 hover:text-white hover:bg-surface-500/50
                     transition-all duration-200"
              aria-label="Детальний прогрес"
            >
              <svg class="w-3.5 h-3.5 expand-icon transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
              </svg>
            </button>
          </div>

          <!-- Expandable stage details -->
          <div class="stage-details overflow-hidden max-h-0 transition-all duration-300 ease-in-out">
            <div class="pt-3 space-y-2">
              {game.stageDetails!.map((detail) => (
                <div class="flex items-center gap-2">
                  <span class="text-[10px] text-surface-300 font-medium w-[72px] flex-shrink-0 truncate">
                    {detail.label}
                  </span>
                  <div class="flex-1 h-1 rounded-full bg-surface-600/60 overflow-hidden">
                    <div
                      class="h-full rounded-full transition-all duration-500"
                      class:list={[
                        detail.percent >= 100 ? "bg-steam-green" :
                        detail.percent > 0 ? "bg-steam-blue" : "bg-surface-500",
                      ]}
                      style={`width: ${detail.percent}%`}
                    />
                  </div>
                  <span class="text-[10px] font-bold tabular-nums text-surface-300 w-[28px] text-right">
                    {detail.percent}%
                  </span>
                </div>
              ))}
            </div>
          </div>
        </div>
      ) : (
        <ProgressBar percent={game.progress} size="sm" />
      )}
    </div>

    <!-- Tags -->
    <div class="flex flex-wrap gap-1 mb-4">
      {game.tags.map((tag) => <Tag label={tag} />)}
    </div>

    <!-- Details button - prominent link to full game page -->
    <a
      href={`/projects/${game.id}`}
      class="block w-full px-3 py-2.5 text-xs font-bold text-center
             rounded-lg border transition-all duration-200
             bg-accent/10 text-accent-light border-accent/30
             hover:bg-accent/20 hover:border-accent/50 hover:shadow-lg hover:shadow-accent/20
             flex items-center justify-center gap-2 group"
    >
      <svg class="w-4 h-4 transition-transform group-hover:scale-110" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      Детальна інформація
    </a>

    <!-- Action buttons row -->
    <div class="flex items-center gap-1.5 mt-2">
      {game.downloadUrl ? (
        <a
          href={game.downloadUrl}
          class="flex-1 inline-flex items-center justify-center gap-1.5 px-3 py-2 text-xs font-semibold
                 rounded-lg border transition-all duration-200
                 bg-steam-green/15 text-steam-green border-steam-green/25
                 hover:bg-steam-green/25 hover:border-steam-green/40"
        >
          <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
          </svg>
          Завантажити
        </a>
      ) : (
        <span
          class="flex-1 inline-flex items-center justify-center gap-1.5 px-3 py-2 text-xs font-semibold
                 rounded-lg border transition-all duration-200
                 bg-surface-600/40 text-surface-400 border-white/[0.04] cursor-not-allowed"
        >
          <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
          </svg>
          Скоро
        </span>
      )}

      {game.steamUrl && (
        <a
          href={game.steamUrl}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center justify-center w-9 h-9 rounded-lg border transition-all duration-200
                 bg-surface-600/40 text-surface-300 border-white/[0.04]
                 hover:bg-surface-500/40 hover:text-white hover:border-white/15"
          aria-label="Сторінка в Steam"
        >
          <i class="fa-brands fa-steam"></i>
        </a>
      )}

      {(game.status === "fundraising" || game.fundraisingGoal) && (
        <a
          href={game.donateUrl}
          class="inline-flex items-center justify-center w-9 h-9 rounded-lg border transition-all duration-200
                 bg-surface-600/40 text-surface-300 border-white/[0.04]
                 hover:bg-accent/15 hover:text-accent-light hover:border-accent/25"
          aria-label="Підтримати"
        >
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
          </svg>
        </a>
      )}
    </div>
  </div>
</article>

<script>
  document.querySelectorAll('.game-progress-toggle').forEach((toggle) => {
    const btn = toggle.querySelector('.expand-btn');
    const icon = toggle.querySelector('.expand-icon');
    const details = toggle.querySelector('.stage-details') as HTMLElement;
    if (!btn || !icon || !details) return;

    // Find the description in the same card
    const card = toggle.closest('article');
    const desc = card?.querySelector('.card-desc');

    const handleClick = (e: Event) => {
      e.stopPropagation();
      const expanded = toggle.getAttribute('data-expanded') === 'true';
      toggle.setAttribute('data-expanded', String(!expanded));

      if (!expanded) {
        details.style.maxHeight = details.scrollHeight + 'px';
        icon.classList.add('rotate-180');
        desc?.classList.remove('line-clamp-2');
      } else {
        details.style.maxHeight = '0px';
        icon.classList.remove('rotate-180');
        desc?.classList.add('line-clamp-2');
      }
    };

    btn.addEventListener('click', handleClick);
    // Also toggle when clicking the progress area
    toggle.addEventListener('click', handleClick);
  });
</script>
