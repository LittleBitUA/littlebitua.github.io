---
// ─── Overall Progress Section ──────────────────────────────────
// Shows aggregate progress across all localization projects.

import ProgressBar from "./ProgressBar.astro";
import { games, getOverallProgress, STATUS_LABELS, STATUS_COLORS } from "../data/games";

const overall = getOverallProgress();
const R = 52;
const C = 2 * Math.PI * R;
const progressOffset = C * (1 - overall / 100);

// Per-game mini stats
const sorted = [...games].sort((a, b) => b.progress - a.progress);
---

<section id="progress" class="py-20">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    <!-- Section header -->
    <div class="text-center mb-12" data-animate>
      <h2 class="text-3xl sm:text-4xl font-extrabold text-white mb-3">
        Загальний прогрес
      </h2>
      <p class="text-surface-300 max-w-lg mx-auto">
        Середній прогрес перекладу по всіх проєктах
      </p>
    </div>

    <!-- Big progress ring + per-game breakdown -->
    <div class="glass p-8 sm:p-10" data-animate>
      <div class="grid lg:grid-cols-[280px_1fr] gap-10 items-center">
        <!-- Circular progress display -->
        <div class="flex flex-col items-center">
          <div class="relative w-48 h-48 mb-4">
            <svg class="w-full h-full -rotate-90" viewBox="0 0 120 120">
              <defs>
                <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="#6d5dfc" />
                  <stop offset="100%" stop-color="#1b9aaa" />
                </linearGradient>
                <filter id="progressGlow">
                  <feGaussianBlur stdDeviation="3" result="blur" />
                  <feMerge>
                    <feMergeNode in="blur" />
                    <feMergeNode in="SourceGraphic" />
                  </feMerge>
                </filter>
              </defs>
              <!-- Background circle -->
              <circle
                cx="60" cy="60" r={R}
                fill="none"
                stroke="currentColor"
                class="text-surface-600/60"
                stroke-width="8"
              />
              <!-- Progress arc -->
              <circle
                cx="60" cy="60" r={R}
                fill="none"
                stroke="url(#progressGradient)"
                stroke-width="8.5"
                stroke-linecap="round"
                stroke-dasharray={C}
                stroke-dashoffset={C}
                filter="url(#progressGlow)"
                class="overall-ring"
                style={`--ring-target: ${progressOffset}`}
              />
            </svg>
            <!-- Centered number -->
            <div class="absolute inset-0 flex items-center justify-center">
              <span class="text-4xl font-extrabold text-white tabular-nums overall-counter" data-target={overall}>0%</span>
            </div>
          </div>
          <p class="text-sm text-surface-300">Середній прогрес усіх проєктів</p>
        </div>

        <!-- Per-game breakdown -->
        <div class="space-y-4" data-animate-stagger>
          {sorted.map((game) => (
            <div class="flex items-center gap-4">
              <span class="w-48 text-sm text-surface-200 truncate shrink-0">
                {game.title}
              </span>
              <div class="flex-1">
                <ProgressBar percent={game.progress} showLabel={false} size="sm" />
              </div>
              <div class="flex items-center gap-2 shrink-0">
                <span class="text-sm font-bold text-white tabular-nums w-10 text-right">
                  {game.progress}%
                </span>
                <span
                  class:list={[
                    "text-[10px] font-bold px-2 py-0.5 rounded border",
                    STATUS_COLORS[game.status],
                  ]}
                >
                  {STATUS_LABELS[game.status]}
                </span>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .overall-ring {
    transition: stroke-dashoffset 2s cubic-bezier(0.16, 1, 0.3, 1);
  }
  .overall-ring.animate {
    stroke-dashoffset: var(--ring-target) !important;
  }
</style>

<script>
  const section = document.getElementById("progress");
  if (section) {
    const ring = section.querySelector(".overall-ring");
    const counter = section.querySelector(".overall-counter") as HTMLSpanElement | null;
    let animated = false;

    const obs = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting && !animated) {
            animated = true;
            if (ring) ring.classList.add("animate");
            if (counter) {
              const target = parseInt(counter.dataset.target || "0", 10);
              const duration = 1800;
              const start = performance.now();
              const tick = (now: number) => {
                const elapsed = now - start;
                const progress = Math.min(elapsed / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                counter.textContent = `${Math.round(eased * target)}%`;
                if (progress < 1) requestAnimationFrame(tick);
              };
              requestAnimationFrame(tick);
            }
          }
        });
      },
      { threshold: 0.3 }
    );
    obs.observe(section);
  }
</script>
