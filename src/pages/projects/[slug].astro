---
// ─── Project Detail Page ─────────────────────────────────────────
// Dynamic route for individual game localization project pages

import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import ProgressBar from "../../components/ProgressBar.astro";
import Tag from "../../components/Tag.astro";
import { games, STATUS_LABELS, STATUS_COLORS, STAGE_COLORS } from "../../data/games";
import "@fortawesome/fontawesome-free/css/all.css";
import type { Game } from "../../data/games";
import {
  SITE_URL,
  getCanonicalUrl,
  generateGameStructuredData,
  generateBreadcrumbs,
  generateKeywords,
} from "../../utils/seo";
import { marked } from "marked";

// Generate static paths for all games
export function getStaticPaths() {
  return games.map((game) => ({
    params: { slug: game.id },
    props: { game },
  }));
}

const { game } = Astro.props as { game: Game };

// SEO data
const pageTitle = `${game.title} — Українська локалізація | Little Bit`;
const pageDescription = game.detailedDescription || game.description;
const canonicalUrl = getCanonicalUrl(`projects/${game.id}`);
const ogImage = `${SITE_URL}${game.cover}`;
const keywords = generateKeywords(game);

// Structured data
const gameStructuredData = generateGameStructuredData(game);
const breadcrumbsData = generateBreadcrumbs([
  { name: "Головна", url: SITE_URL },
  { name: "Проєкти", url: `${SITE_URL}/#projects` },
  { name: game.title, url: canonicalUrl },
]);

// Combined structured data
const structuredData = `[${gameStructuredData},${breadcrumbsData}]`;

// Status/stage info
const statusLabel = game.status === "fundraising" ? STATUS_LABELS[game.status] : (game.stage ?? STATUS_LABELS[game.status]);
const statusColor = STATUS_COLORS[game.status];
const stageColor = game.stage ? STAGE_COLORS[game.stage] : "";

// Navigation (previous/next games)
const currentIndex = games.findIndex((g) => g.id === game.id);
const prevGame = currentIndex > 0 ? games[currentIndex - 1] : null;
const nextGame = currentIndex < games.length - 1 ? games[currentIndex + 1] : null;
---

<Layout
  title={pageTitle}
  description={pageDescription}
  canonicalUrl={canonicalUrl}
  ogImage={ogImage}
  ogType="product"
  keywords={keywords}
  structuredData={structuredData}
>
  <Header />

  <main class="flex-1">
    <!-- Breadcrumbs -->
    <nav class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pt-24 pb-6">
      <ol class="flex items-center gap-2 text-xs text-surface-400">
        <li><a href="/" class="hover:text-white transition-colors">Головна</a></li>
        <li><svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
        </svg></li>
        <li><a href="/#projects" class="hover:text-white transition-colors">Проєкти</a></li>
        <li><svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
        </svg></li>
        <li class="text-white font-semibold">{game.title}</li>
      </ol>
    </nav>

    <!-- Hero Section -->
    <section class="relative overflow-hidden">
      <!-- Background cover (blurred) -->
      <div class="absolute inset-0 -z-10">
        <img
          src={game.cover}
          alt=""
          class="absolute inset-0 w-full h-full object-cover scale-110 blur-2xl opacity-40"
          aria-hidden="true"
        />
        <div class="absolute inset-0 bg-gradient-to-b from-surface-900/60 via-surface-900/80 to-surface-900" />
      </div>

      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-12">
        <div class="grid grid-cols-1 lg:grid-cols-[300px_1fr] gap-8 items-start">
          <!-- Cover -->
          <div class="mx-auto lg:mx-0">
            <div class="relative w-full max-w-[300px] aspect-[2/3] rounded-xl overflow-hidden border border-white/10 shadow-2xl">
              <img
                src={game.cover}
                alt={game.title}
                class="absolute inset-0 w-full h-full object-cover"
              />
              <!-- Status badge -->
              <div class="absolute top-3 left-3">
                <span
                  class:list={[
                    "inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-bold rounded-lg border backdrop-blur-md bg-black/70",
                    game.stage && (game.status === "early-access" || game.status === "in-progress")
                      ? `${stageColor} border-white/20`
                      : statusColor,
                  ]}
                >
                  {statusLabel}
                </span>
              </div>
            </div>
          </div>

          <!-- Info -->
          <div class="space-y-6">
            <!-- Title -->
            <div>
              <h1 class="text-4xl sm:text-5xl font-black text-white leading-tight mb-3">
                {game.title}
              </h1>
              <p class="text-surface-200 text-lg leading-relaxed">
                {game.detailedDescription || game.description}
              </p>
            </div>

            <!-- Progress -->
            <div class="space-y-2">
              <div class="flex items-center justify-between text-sm">
                <span class="text-surface-300 font-medium">Прогрес локалізації</span>
                <span class="text-white font-bold tabular-nums">{game.progress}%</span>
              </div>
              <ProgressBar percent={game.progress} showLabel={false} />
            </div>

            <!-- Stats -->
            {game.stats && (
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                {game.stats.totalLines && (
                  <div class="bg-white/[0.03] border border-white/[0.06] rounded-lg p-3">
                    <p class="text-2xl font-black text-white tabular-nums">
                      {game.stats.totalLines.toLocaleString("uk-UA")}
                    </p>
                    <p class="text-xs text-surface-400 mt-1">Рядків тексту</p>
                  </div>
                )}
                {game.stats.totalWords && (
                  <div class="bg-white/[0.03] border border-white/[0.06] rounded-lg p-3">
                    <p class="text-2xl font-black text-white tabular-nums">
                      {game.stats.totalWords.toLocaleString("uk-UA")}
                    </p>
                    <p class="text-xs text-surface-400 mt-1">Слів</p>
                  </div>
                )}
                {game.gameYear && (
                  <div class="bg-white/[0.03] border border-white/[0.06] rounded-lg p-3">
                    <p class="text-2xl font-black text-white tabular-nums">{game.gameYear}</p>
                    <p class="text-xs text-surface-400 mt-1">Рік випуску</p>
                  </div>
                )}
                {game.releaseDate && (
                  <div class="bg-white/[0.03] border border-white/[0.06] rounded-lg p-3">
                    <p class="text-2xl font-black text-steam-green tabular-nums">
                      {new Date(game.releaseDate).toLocaleDateString("uk-UA", { day: "numeric", month: "short" })}
                    </p>
                    <p class="text-xs text-surface-400 mt-1">Дата релізу</p>
                  </div>
                )}
              </div>
            )}

            <!-- Tags -->
            {game.tags.length > 0 && (
              <div class="flex flex-wrap gap-2">
                {game.tags.map((tag) => (
                  <Tag text={tag} size="md" />
                ))}
              </div>
            )}

            <!-- Fundraising block (completed) -->
            {game.fundraisingCompleted && (
              <div class="rounded-xl border border-steam-green/25 bg-steam-green/[0.05] p-5">
                <div class="flex items-center gap-2 mb-2">
                  <svg class="w-4 h-4 text-steam-green" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  <span class="text-sm font-bold text-steam-green">Збір коштів завершено!</span>
                </div>
                <p class="text-sm text-surface-300">
                  Спільнота зібрала необхідну суму — дякуємо всім, хто підтримав проєкт! Переклад активно розвивається.
                </p>
              </div>
            )}

            <!-- Fundraising block (active) -->
            {game.fundraisingGoal && (
              <div class="rounded-xl border border-orange-400/25 bg-orange-400/[0.05] p-5">
                <div class="flex items-center gap-2 mb-3">
                  <svg class="w-4 h-4 text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                  </svg>
                  <span class="text-sm font-bold text-orange-400">Збір коштів</span>
                </div>
                <p class="text-sm text-surface-300 mb-4">
                  Ми збираємо кошти на текстову локалізацію цієї гри. Підтримайте проєкт, щоб переклад вийшов якнайшвидше!
                </p>
                {(() => {
                  const raised = game.fundraisingRaised ?? 0;
                  const goal = game.fundraisingGoal ?? 0;
                  const pct = goal > 0 ? Math.min(100, Math.round((raised / goal) * 100)) : 0;
                  return (
                    <div class="mb-4">
                      <div class="flex items-center justify-between mb-1.5">
                        <span class="text-xs text-surface-400">Зібрано</span>
                        <span class="text-xs font-bold text-orange-400 tabular-nums">
                          {raised.toLocaleString("uk-UA")}₴ з {goal.toLocaleString("uk-UA")}₴ · {pct}%
                        </span>
                      </div>
                      <div class="h-2 rounded-full bg-white/10 overflow-hidden">
                        <div
                          class="h-full rounded-full bg-gradient-to-r from-orange-400 to-orange-300"
                          style={`width: ${pct}%`}
                        />
                      </div>
                    </div>
                  );
                })()}
                <a
                  href={game.donateUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 px-5 py-2.5 text-sm font-bold rounded-xl
                         bg-orange-400/15 text-orange-400 border border-orange-400/30
                         hover:bg-orange-400/25 hover:border-orange-400/40
                         transition-all duration-200"
                >
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                  </svg>
                  Задонатити
                </a>
              </div>
            )}

            <!-- Action buttons -->
            <div class="flex flex-wrap gap-3 pt-2">
              {game.downloadUrl && (
                <a
                  href={game.downloadUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 px-6 py-3 text-sm font-bold rounded-xl
                         bg-accent text-white border border-accent
                         hover:bg-accent/90 hover:shadow-lg hover:shadow-accent/20
                         transition-all duration-200"
                >
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                  </svg>
                  Завантажити
                </a>
              )}
              {game.steamUrl && (
                <a
                  href={game.steamUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 px-6 py-3 text-sm font-bold rounded-xl
                         bg-steam-blue/15 text-steam-blue border border-steam-blue/30
                         hover:bg-steam-blue/25 hover:border-steam-blue/40
                         transition-all duration-200"
                >
                  <i class="fa-brands fa-steam"></i>
                  Steam
                </a>
              )}
              <a
                href={game.donateUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-2 px-6 py-3 text-sm font-bold rounded-xl
                       bg-white/[0.04] text-surface-200 border border-white/[0.08]
                       hover:bg-white/[0.08] hover:border-white/[0.15] hover:text-white
                       transition-all duration-200"
              >
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                </svg>
                Підтримати
              </a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Content sections -->
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-16 space-y-16">
      <!-- Install Instructions -->
      {game.installInstructions && (
        <section>
          <h2 class="text-2xl font-black text-white mb-6">Встановлення</h2>
          <div
            class="prose prose-invert prose-sm sm:prose-base max-w-none
                   bg-white/[0.03] border border-white/[0.06] rounded-xl p-6 sm:p-8"
            set:html={marked(game.installInstructions)}
          />
        </section>
      )}

      <!-- Progress History Chart (if available) -->
      {game.progressHistory && game.progressHistory.length > 0 && (
        <section>
          <h2 class="text-2xl font-black text-white mb-6">Історія прогресу</h2>
          <div class="bg-white/[0.03] border border-white/[0.06] rounded-xl p-6">
            <canvas id="progress-chart" class="max-h-[300px]"></canvas>
          </div>
        </section>
      )}
    </div>

    <!-- Navigation (prev/next) -->
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-12 border-t border-white/[0.06]">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        {prevGame ? (
          <a
            href={`/projects/${prevGame.id}`}
            class="group flex items-center gap-4 p-4 rounded-xl bg-white/[0.03] border border-white/[0.06]
                   hover:bg-white/[0.06] hover:border-white/[0.10] transition-all"
          >
            <svg class="w-5 h-5 text-surface-400 group-hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
            <div class="flex-1 min-w-0">
              <p class="text-xs text-surface-400 mb-1">Попередній проєкт</p>
              <p class="font-bold text-white truncate">{prevGame.title}</p>
            </div>
          </a>
        ) : <div />}

        {nextGame ? (
          <a
            href={`/projects/${nextGame.id}`}
            class="group flex items-center gap-4 p-4 rounded-xl bg-white/[0.03] border border-white/[0.06]
                   hover:bg-white/[0.06] hover:border-white/[0.10] transition-all text-right"
          >
            <div class="flex-1 min-w-0">
              <p class="text-xs text-surface-400 mb-1">Наступний проєкт</p>
              <p class="font-bold text-white truncate">{nextGame.title}</p>
            </div>
            <svg class="w-5 h-5 text-surface-400 group-hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        ) : <div />}
      </div>
    </div>
  </main>

  <Footer />

  <!-- Progress history chart script -->
  {game.progressHistory && game.progressHistory.length > 0 && (
    <script define:vars={{ progressHistory: game.progressHistory }}>
      import {
        Chart,
        LineController,
        LineElement,
        PointElement,
        LinearScale,
        TimeScale,
        CategoryScale,
        Title,
        Tooltip,
        Legend,
        Filler,
      } from "chart.js";

      Chart.register(
        LineController,
        LineElement,
        PointElement,
        LinearScale,
        TimeScale,
        CategoryScale,
        Title,
        Tooltip,
        Legend,
        Filler
      );

      const ctx = document.getElementById("progress-chart") as HTMLCanvasElement;

      new Chart(ctx, {
        type: "line",
        data: {
          labels: progressHistory.map((entry) =>
            new Date(entry.date).toLocaleDateString("uk-UA", { day: "numeric", month: "short" })
          ),
          datasets: [
            {
              label: "Прогрес (%)",
              data: progressHistory.map((entry) => entry.progress),
              borderColor: "#6d5dfc",
              backgroundColor: "rgba(109, 93, 252, 0.1)",
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 5,
              pointHoverRadius: 7,
              pointBackgroundColor: "#6d5dfc",
              pointBorderColor: "#fff",
              pointBorderWidth: 2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            },
            tooltip: {
              backgroundColor: "rgba(0, 0, 0, 0.9)",
              titleColor: "#fff",
              bodyColor: "#fff",
              borderColor: "rgba(255, 255, 255, 0.1)",
              borderWidth: 1,
              padding: 12,
              displayColors: false,
              callbacks: {
                label: (context) => `${context.parsed.y}%`,
              },
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: (value) => `${value}%`,
                color: "rgba(255, 255, 255, 0.5)",
              },
              grid: {
                color: "rgba(255, 255, 255, 0.05)",
              },
            },
            x: {
              ticks: {
                color: "rgba(255, 255, 255, 0.5)",
              },
              grid: {
                display: false,
              },
            },
          },
        },
      });
    </script>
  )}
</Layout>
