---
// ─── Project Detail Page ─────────────────────────────────────────
// Dynamic route for individual game localization project pages

import Layout from "../../layouts/Layout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import ProgressBar from "../../components/ProgressBar.astro";
import Tag from "../../components/Tag.astro";
import { games, STATUS_LABELS, STATUS_COLORS, STAGE_COLORS } from "../../data/games";
import "@fortawesome/fontawesome-free/css/all.css";
import type { Game } from "../../data/games";
import {
  SITE_URL,
  getCanonicalUrl,
  generateGameStructuredData,
  generateBreadcrumbs,
  generateKeywords,
} from "../../utils/seo";
import { marked } from "marked";

// Generate static paths for all games
export function getStaticPaths() {
  return games.map((game) => ({
    params: { slug: game.id },
    props: { game },
  }));
}

const { game } = Astro.props as { game: Game };

// SEO data
const pageTitle = `${game.title} — Українська локалізація | Little Bit`;
const pageDescription = game.detailedDescription || game.description;
const canonicalUrl = getCanonicalUrl(`projects/${game.id}`);
const ogImage = `${SITE_URL}${game.cover}`;
const keywords = generateKeywords(game);

// Structured data
const gameStructuredData = generateGameStructuredData(game);
const breadcrumbsData = generateBreadcrumbs([
  { name: "Головна", url: SITE_URL },
  { name: "Проєкти", url: `${SITE_URL}/#projects` },
  { name: game.title, url: canonicalUrl },
]);

// Combined structured data
const structuredData = `[${gameStructuredData},${breadcrumbsData}]`;

// Status/stage info
const statusLabel = game.status === "fundraising" ? STATUS_LABELS[game.status] : (game.stage ?? STATUS_LABELS[game.status]);
const statusColor = STATUS_COLORS[game.status];
const stageColor = game.stage ? STAGE_COLORS[game.stage] : "";

// Navigation (previous/next games)
const currentIndex = games.findIndex((g) => g.id === game.id);
const prevGame = currentIndex > 0 ? games[currentIndex - 1] : null;
const nextGame = currentIndex < games.length - 1 ? games[currentIndex + 1] : null;
---

<Layout
  title={pageTitle}
  description={pageDescription}
  canonicalUrl={canonicalUrl}
  ogImage={ogImage}
  ogType="product"
  keywords={keywords}
  structuredData={structuredData}
>
  <Header />

  <main class="flex-1">
    <!-- Breadcrumbs -->
    <nav class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pt-24 pb-6">
      <ol class="flex items-center gap-2 text-xs text-surface-400">
        <li><a href="/" class="hover:text-white transition-colors">Головна</a></li>
        <li><svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
        </svg></li>
        <li><a href="/#projects" class="hover:text-white transition-colors">Проєкти</a></li>
        <li><svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
        </svg></li>
        <li class="text-white font-semibold">{game.title}</li>
      </ol>
    </nav>

    <!-- Hero Section -->
    <section class="relative overflow-hidden">
      <!-- Background cover (blurred) -->
      <div class="absolute inset-0 -z-10">
        <img
          src={game.cover}
          alt=""
          class="absolute inset-0 w-full h-full object-cover scale-110 blur-2xl opacity-40"
          aria-hidden="true"
        />
        <div class="absolute inset-0 bg-gradient-to-b from-surface-900/60 via-surface-900/80 to-surface-900" />
      </div>

      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-12">
        <div class="grid grid-cols-1 lg:grid-cols-[300px_1fr] gap-8 items-start">
          <!-- Cover -->
          <div class="mx-auto lg:mx-0">
            <div class="relative w-full max-w-[300px] aspect-[2/3] rounded-xl overflow-hidden border border-white/10 shadow-2xl">
              <img
                src={game.cover}
                alt={game.title}
                class="absolute inset-0 w-full h-full object-cover"
              />
              <!-- Status badge -->
              <div class="absolute top-3 left-3">
                <span
                  class:list={[
                    "inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-bold rounded-lg border backdrop-blur-md bg-black/70",
                    game.stage && (game.status === "early-access" || game.status === "in-progress")
                      ? `${stageColor} border-white/20`
                      : statusColor,
                  ]}
                >
                  {statusLabel}
                </span>
              </div>
            </div>
          </div>

          <!-- Info -->
          <div class="space-y-6">
            <!-- Title -->
            <div>
              <h1 class="text-4xl sm:text-5xl font-black text-white leading-tight mb-3">
                {game.title}
              </h1>
              <p class="text-surface-200 text-lg leading-relaxed">
                {game.detailedDescription || game.description}
              </p>
            </div>

            <!-- Progress -->
            <div class="space-y-2">
              <div class="flex items-center justify-between text-sm">
                <span class="text-surface-300 font-medium">Прогрес локалізації</span>
                <span class="text-white font-bold tabular-nums">{game.progress}%</span>
              </div>
              <ProgressBar percent={game.progress} showLabel={false} />
            </div>

            <!-- Stats -->
            {game.stats && (
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                {game.stats.totalLines && (
                  <div class="bg-white/[0.03] border border-white/[0.06] rounded-lg p-3">
                    <p class="text-2xl font-black text-white tabular-nums">
                      {game.stats.totalLines.toLocaleString("uk-UA")}
                    </p>
                    <p class="text-xs text-surface-400 mt-1">Рядків тексту</p>
                  </div>
                )}
                {game.stats.totalWords && (
                  <div class="bg-white/[0.03] border border-white/[0.06] rounded-lg p-3">
                    <p class="text-2xl font-black text-white tabular-nums">
                      {game.stats.totalWords.toLocaleString("uk-UA")}
                    </p>
                    <p class="text-xs text-surface-400 mt-1">Слів</p>
                  </div>
                )}
                {game.gameYear && (
                  <div class="bg-white/[0.03] border border-white/[0.06] rounded-lg p-3">
                    <p class="text-2xl font-black text-white tabular-nums">{game.gameYear}</p>
                    <p class="text-xs text-surface-400 mt-1">Рік випуску</p>
                  </div>
                )}
                {game.releaseDate && (
                  <div class="bg-white/[0.03] border border-white/[0.06] rounded-lg p-3">
                    <p class="text-2xl font-black text-steam-green tabular-nums">
                      {new Date(game.releaseDate).toLocaleDateString("uk-UA", { day: "numeric", month: "short" })}
                    </p>
                    <p class="text-xs text-surface-400 mt-1">Дата релізу</p>
                  </div>
                )}
              </div>
            )}

            <!-- Screenshots Gallery (inline) -->
            {game.screenshots && game.screenshots.length > 0 && (
              <div>
                <div class="grid grid-cols-3 sm:grid-cols-5 gap-2">
                  {game.screenshots.map((src, i) => (
                    <div
                      class="gallery-thumb group relative rounded-lg overflow-hidden border border-white/[0.06]
                             hover:border-accent/50 hover:shadow-lg hover:shadow-accent/10 transition-all duration-200 cursor-pointer"
                      data-index={i}
                      role="button"
                      tabindex="0"
                    >
                      <img
                        src={src}
                        alt={`Скріншот ${i + 1}`}
                        class="w-full h-auto block"
                        loading="lazy"
                      />
                      <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors duration-200 flex items-center justify-center">
                        <svg class="w-6 h-6 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-200 drop-shadow-lg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607zM10.5 7.5v6m3-3h-6" />
                        </svg>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}

            <!-- Fundraising block (completed) -->
            {game.fundraisingCompleted && (
              <div class="rounded-xl border border-steam-green/25 bg-steam-green/[0.05] p-5">
                <div class="flex items-center gap-2 mb-2">
                  <svg class="w-4 h-4 text-steam-green" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  <span class="text-sm font-bold text-steam-green">Збір коштів завершено!</span>
                </div>
                <p class="text-sm text-surface-300">
                  Спільнота зібрала необхідну суму — дякуємо всім, хто підтримав проєкт! Переклад активно розвивається.
                </p>
              </div>
            )}

            <!-- Fundraising block (active) -->
            {game.fundraisingGoal && (
              <div class="rounded-xl border border-orange-400/25 bg-orange-400/[0.05] p-5">
                <div class="flex items-center gap-2 mb-3">
                  <svg class="w-4 h-4 text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                  </svg>
                  <span class="text-sm font-bold text-orange-400">Збір коштів</span>
                </div>
                <p class="text-sm text-surface-300 mb-4">
                  {game.fundraisingDescription || "Ми збираємо кошти на текстову локалізацію цієї гри. Підтримайте проєкт, щоб переклад вийшов якнайшвидше!"}
                </p>
                {(() => {
                  const raised = game.fundraisingRaised ?? 0;
                  const goal = game.fundraisingGoal ?? 0;
                  const pct = goal > 0 ? Math.min(100, Math.round((raised / goal) * 100)) : 0;
                  return (
                    <div class="mb-4">
                      <div class="flex items-center justify-between mb-1.5">
                        <span class="text-xs text-surface-400">Зібрано</span>
                        <span class="text-xs font-bold text-orange-400 tabular-nums">
                          {raised.toLocaleString("uk-UA")}₴ з {goal.toLocaleString("uk-UA")}₴ · {pct}%
                        </span>
                      </div>
                      <div class="h-2 rounded-full bg-white/10 overflow-hidden">
                        <div
                          id="fundraising-bar"
                          class="h-full rounded-full bg-gradient-to-r from-orange-400 to-orange-300"
                          style="width: 0%"
                          data-target={`${pct}`}
                        />
                      </div>
                    </div>
                  );
                })()}
                <div class="relative inline-block">
                  <a
                    href={game.donateUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center gap-2 px-5 py-2.5 text-sm font-bold rounded-xl
                           bg-orange-400/15 text-orange-400 border border-orange-400/30
                           hover:bg-orange-400/25 hover:border-orange-400/40
                           transition-all duration-200 relative z-10"
                  >
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                    Задонатити
                  </a>
                  <canvas id="confetti-canvas" class="absolute -top-8 -left-8 -right-8 -bottom-8 pointer-events-none z-20" style="width: calc(100% + 64px); height: calc(100% + 64px);"></canvas>
                </div>
              </div>
            )}

            <!-- Action buttons -->
            <div class="flex flex-wrap gap-3 pt-2">
              {game.downloadUrl && (
                <a
                  href={game.downloadUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 px-6 py-3 text-sm font-bold rounded-xl
                         bg-accent text-white border border-accent
                         hover:bg-accent/90 hover:shadow-lg hover:shadow-accent/20
                         transition-all duration-200"
                >
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                  </svg>
                  Завантажити
                </a>
              )}
              {game.steamUrl && (
                <a
                  href={game.steamUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 px-6 py-3 text-sm font-bold rounded-xl
                         bg-steam-blue/15 text-steam-blue border border-steam-blue/30
                         hover:bg-steam-blue/25 hover:border-steam-blue/40
                         transition-all duration-200"
                >
                  <i class="fa-brands fa-steam"></i>
                  Steam
                </a>
              )}
              <a
                href={game.donateUrl}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-2 px-6 py-3 text-sm font-bold rounded-xl
                       bg-white/[0.04] text-surface-200 border border-white/[0.08]
                       hover:bg-white/[0.08] hover:border-white/[0.15] hover:text-white
                       transition-all duration-200"
              >
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                </svg>
                Підтримати
              </a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Lightbox -->
    {game.screenshots && game.screenshots.length > 0 && (
      <div id="lightbox" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/90 backdrop-blur-sm">
        <button id="lb-close" type="button" class="absolute top-4 right-4 z-10 p-2 text-white/70 hover:text-white transition-colors cursor-pointer">
          <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
        <button id="lb-prev" type="button" class="absolute left-4 top-1/2 -translate-y-1/2 z-10 p-2 text-white/70 hover:text-white transition-colors cursor-pointer">
          <svg class="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        <button id="lb-next" type="button" class="absolute right-4 top-1/2 -translate-y-1/2 z-10 p-2 text-white/70 hover:text-white transition-colors cursor-pointer">
          <svg class="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
          </svg>
        </button>
        <div class="flex items-center justify-center w-full h-full p-12">
          <img id="lb-img" src="" alt="" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl" />
        </div>
        <div id="lb-counter" class="absolute bottom-4 left-1/2 -translate-x-1/2 text-sm text-white/60 tabular-nums"></div>
      </div>
    )}

    <!-- Content sections -->
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-16 space-y-16">
      <!-- Install Instructions or "in progress" notice -->
      {game.installInstructions ? (
        <section>
          <h2 class="text-2xl font-black text-white mb-6">Встановлення</h2>
          <div
            class="prose prose-invert prose-sm sm:prose-base max-w-none
                   bg-white/[0.03] border border-white/[0.06] rounded-xl p-6 sm:p-8"
            set:html={marked(game.installInstructions)}
          />
        </section>
      ) : (
        <section>
          <h2 class="text-2xl font-black text-white mb-6">Встановлення</h2>
          <div class="bg-white/[0.03] border border-white/[0.06] rounded-xl p-6 sm:p-8 flex items-center gap-3">
            <svg class="w-5 h-5 text-surface-400 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <p class="text-sm text-surface-300">
              Локалізація наразі у роботі. Інструкції зі встановлення з'являться, коли переклад буде доступний для завантаження.
            </p>
          </div>
        </section>
      )}

      <!-- Progress History Chart (if available) -->
      {game.progressHistory && game.progressHistory.length > 0 && (
        <section>
          <h2 class="text-2xl font-black text-white mb-6">Історія прогресу</h2>
          <div class="bg-white/[0.03] border border-white/[0.06] rounded-xl p-6">
            <canvas id="progress-chart" class="max-h-[300px]"></canvas>
          </div>
        </section>
      )}
    </div>

    <!-- Navigation (prev/next) -->
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-12 border-t border-white/[0.06]">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        {prevGame ? (
          <a
            href={`/projects/${prevGame.id}`}
            class="group flex items-center gap-4 p-4 rounded-xl bg-white/[0.03] border border-white/[0.06]
                   hover:bg-white/[0.06] hover:border-white/[0.10] transition-all"
          >
            <svg class="w-5 h-5 text-surface-400 group-hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
            </svg>
            <div class="flex-1 min-w-0">
              <p class="text-xs text-surface-400 mb-1">Попередній проєкт</p>
              <p class="font-bold text-white truncate">{prevGame.title}</p>
            </div>
          </a>
        ) : <div />}

        {nextGame ? (
          <a
            href={`/projects/${nextGame.id}`}
            class="group flex items-center gap-4 p-4 rounded-xl bg-white/[0.03] border border-white/[0.06]
                   hover:bg-white/[0.06] hover:border-white/[0.10] transition-all text-right"
          >
            <div class="flex-1 min-w-0">
              <p class="text-xs text-surface-400 mb-1">Наступний проєкт</p>
              <p class="font-bold text-white truncate">{nextGame.title}</p>
            </div>
            <svg class="w-5 h-5 text-surface-400 group-hover:text-white transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        ) : <div />}
      </div>
    </div>
  </main>

  <Footer />

  <!-- Screenshot gallery lightbox script -->
  {game.screenshots && game.screenshots.length > 0 && (
    <script define:vars={{ screenshots: game.screenshots }}>
      const lightbox = document.getElementById("lightbox");
      const lbImg = document.getElementById("lb-img");
      const lbCounter = document.getElementById("lb-counter");
      let currentIndex = 0;

      function showImage(index) {
        currentIndex = ((index % screenshots.length) + screenshots.length) % screenshots.length;
        lbImg.src = screenshots[currentIndex];
        lbImg.alt = `Скріншот ${currentIndex + 1}`;
        lbCounter.textContent = `${currentIndex + 1} / ${screenshots.length}`;
      }

      function openLightbox(index) {
        showImage(index);
        lightbox.classList.remove("hidden");
        lightbox.classList.add("flex");
        document.body.style.overflow = "hidden";
      }

      function closeLightbox() {
        lightbox.classList.add("hidden");
        lightbox.classList.remove("flex");
        document.body.style.overflow = "";
      }

      document.querySelectorAll(".gallery-thumb").forEach((thumb) => {
        thumb.addEventListener("click", () => {
          openLightbox(parseInt(thumb.dataset.index, 10));
        });
      });

      document.getElementById("lb-close").addEventListener("click", closeLightbox);
      document.getElementById("lb-prev").addEventListener("click", () => showImage(currentIndex - 1));
      document.getElementById("lb-next").addEventListener("click", () => showImage(currentIndex + 1));

      lightbox.addEventListener("click", (e) => {
        if (e.target === lightbox || e.target === lightbox.querySelector(".flex")) closeLightbox();
      });

      document.addEventListener("keydown", (e) => {
        if (lightbox.classList.contains("hidden")) return;
        if (e.key === "Escape") closeLightbox();
        if (e.key === "ArrowLeft") showImage(currentIndex - 1);
        if (e.key === "ArrowRight") showImage(currentIndex + 1);
      });
    </script>
  )}

  <!-- Fundraising bar animation + confetti -->
  {game.fundraisingGoal && (
    <script>
      const bar = document.getElementById("fundraising-bar");
      if (bar) {
        const target = parseInt(bar.dataset.target, 10);
        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              bar.style.transition = "width 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94)";
              bar.style.width = target + "%";

              if (target >= 100) {
                setTimeout(() => spawnConfetti(), 1200);
              }
              observer.disconnect();
            }
          });
        }, { threshold: 0.5 });
        observer.observe(bar);
      }

      function spawnConfetti() {
        const canvas = document.getElementById("confetti-canvas");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        canvas.width = canvas.offsetWidth * 2;
        canvas.height = canvas.offsetHeight * 2;
        ctx.scale(2, 2);
        const W = canvas.offsetWidth;
        const H = canvas.offsetHeight;
        const colors = ["#fb923c", "#fbbf24", "#34d399", "#60a5fa", "#a78bfa", "#f472b6"];
        const pieces = [];

        for (let i = 0; i < 40; i++) {
          pieces.push({
            x: W / 2 + (Math.random() - 0.5) * 60,
            y: H / 2,
            vx: (Math.random() - 0.5) * 6,
            vy: -(Math.random() * 4 + 2),
            size: Math.random() * 5 + 3,
            color: colors[Math.floor(Math.random() * colors.length)],
            rotation: Math.random() * 360,
            rotSpeed: (Math.random() - 0.5) * 12,
            gravity: 0.12,
            opacity: 1,
          });
        }

        let frame = 0;
        function draw() {
          ctx.clearRect(0, 0, W, H);
          let alive = false;
          pieces.forEach((p) => {
            if (p.opacity <= 0) return;
            alive = true;
            p.x += p.vx;
            p.vy += p.gravity;
            p.y += p.vy;
            p.rotation += p.rotSpeed;
            if (frame > 30) p.opacity -= 0.02;

            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate((p.rotation * Math.PI) / 180);
            ctx.globalAlpha = Math.max(0, p.opacity);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size * 0.6);
            ctx.restore();
          });
          frame++;
          if (alive) requestAnimationFrame(draw);
          else ctx.clearRect(0, 0, W, H);
        }
        requestAnimationFrame(draw);
      }
    </script>
  )}

  <!-- Progress history chart script -->
  {game.progressHistory && game.progressHistory.length > 0 && (
    <script define:vars={{ progressHistory: game.progressHistory }}>
      import {
        Chart,
        LineController,
        LineElement,
        PointElement,
        LinearScale,
        TimeScale,
        CategoryScale,
        Title,
        Tooltip,
        Legend,
        Filler,
      } from "chart.js";

      Chart.register(
        LineController,
        LineElement,
        PointElement,
        LinearScale,
        TimeScale,
        CategoryScale,
        Title,
        Tooltip,
        Legend,
        Filler
      );

      const ctx = document.getElementById("progress-chart") as HTMLCanvasElement;

      new Chart(ctx, {
        type: "line",
        data: {
          labels: progressHistory.map((entry) =>
            new Date(entry.date).toLocaleDateString("uk-UA", { day: "numeric", month: "short" })
          ),
          datasets: [
            {
              label: "Прогрес (%)",
              data: progressHistory.map((entry) => entry.progress),
              borderColor: "#6d5dfc",
              backgroundColor: "rgba(109, 93, 252, 0.1)",
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 5,
              pointHoverRadius: 7,
              pointBackgroundColor: "#6d5dfc",
              pointBorderColor: "#fff",
              pointBorderWidth: 2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false,
            },
            tooltip: {
              backgroundColor: "rgba(0, 0, 0, 0.9)",
              titleColor: "#fff",
              bodyColor: "#fff",
              borderColor: "rgba(255, 255, 255, 0.1)",
              borderWidth: 1,
              padding: 12,
              displayColors: false,
              callbacks: {
                label: (context) => `${context.parsed.y}%`,
              },
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: {
                callback: (value) => `${value}%`,
                color: "rgba(255, 255, 255, 0.5)",
              },
              grid: {
                color: "rgba(255, 255, 255, 0.05)",
              },
            },
            x: {
              ticks: {
                color: "rgba(255, 255, 255, 0.5)",
              },
              grid: {
                display: false,
              },
            },
          },
        },
      });
    </script>
  )}
</Layout>
